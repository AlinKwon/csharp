@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="form-group row">
    <label for="userInput" class="col-2 col-form-label">User</label>
    <div class="col col-sm-6">
        <input id="userInput" class="form-control" />
    </div>
</div>

<div class="form-group row">
    <label for="message" class="col-2 col-form-label">Message</label>
    <div class="col col-sm-6">
        <input id="messageInput" class="form-control" />
    </div>
</div>

<button id="send" type="button" class="btn btn-primary">Send Message</button>

<hr>

<ul id="messageList"></ul>

@section Scripts
{
    <script src="~/lib/signalr/signalr.js"></script>
    <script type="text/javascript">
        $(function(){
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/chathub")
                .configureLogging(signalR.LogLevel.Information)
                .build();
            
            connection.on('ReceiveMessage', (user, message) => {
                const li = $('<li></li>');
                $(li).text(`${user}: ${message}`);
                $('#messageList').append(
                    $(li)
                ) ;
            }) ;

            $('#send').click( async () =>{
                const user = $('#userInput').val();
                const message = $('#messageInput').val();

                try {
                    await connection.invoke('SendMessage', user, message);
                } catch (err) {
                    console.error(err) ;
                }
            }) ;

            async function start(){
                try {
                    await connection.start();
                    console.log('SignalR connected.') ;
                } catch (err){
                    console.error(err);
                    setTimeout(start,5000) ;
                }
            }

            connection.onclose(async () => {
                await start() ;
            }) ;

            start() ;
        }) ;
    </script>
}